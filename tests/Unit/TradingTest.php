<?php

namespace Tests\Unit;

use App\Helpers\Trading;
use App\Http\Controllers\MarketController;
use PHPUnit\Framework\TestCase;

class TradingTest extends TestCase
{

    protected $market_candles;

    public function setUp() : void
    {
        parent::setUp();
        $this->market_candles =  [
            [1662298860000, "19772.68000000", "19779.82000000", "19769.74000000", "19770.52000000", "69.42129000", 1662298919999],
            [1662298920000, "19771.58000000", "19779.87000000", "19768.43000000", "19772.33000000", "116.64056000", 1662298979999],
            [1662298980000, "19772.33000000", "19780.00000000", "19771.09000000", "19778.12000000", "66.40162000", 1662299039999],
            [1662299040000, "19779.22000000", "19782.31000000", "19776.80000000", "19781.19000000", "69.72949000", 1662299099999],
            [1662299100000, "19780.99000000", "19795.77000000", "19778.56000000", "19782.37000000", "143.81863000", 1662299159999],
            [1662299160000, "19783.26000000", "19785.03000000", "19772.28000000", "19774.23000000", "111.48257000", 1662299219999],
            [1662299220000, "19774.23000000", "19781.85000000", "19767.03000000", "19770.95000000", "97.14229000", 1662299279999],
            [1662299280000, "19770.95000000", "19775.23000000", "19770.25000000", "19772.29000000", "61.26463000", 1662299339999],
            [1662299340000, "19771.55000000", "19774.58000000", "19766.47000000", "19767.16000000", "70.91218000", 1662299399999],
            [1662299400000, "19767.16000000", "19768.45000000", "19740.56000000", "19756.71000000", "318.26892000", 1662299459999],
            [1662299460000, "19756.71000000", "19760.40000000", "19744.29000000", "19751.90000000", "136.44740000", 1662299519999],
            [1662299520000, "19752.57000000", "19754.77000000", "19740.36000000", "19745.43000000", "199.15762000", 1662299579999],
            [1662299580000, "19746.63000000", "19746.63000000", "19734.99000000", "19742.55000000", "156.12545000", 1662299639999],
            [1662299640000, "19741.82000000", "19745.00000000", "19707.40000000", "19713.44000000", "448.80547000", 1662299699999],
            [1662299700000, "19713.44000000", "19737.55000000", "19708.51000000", "19727.21000000", "308.27717000", 1662299759999],
            [1662299760000, "19728.29000000", "19738.90000000", "19720.01000000", "19723.91000000", "162.52773000", 1662299819999],
            [1662299820000, "19724.62000000", "19726.07000000", "19714.08000000", "19719.80000000", "137.84718000", 1662299879999],
            [1662299880000, "19719.80000000", "19726.77000000", "19685.15000000", "19704.99000000", "438.51162000", 1662299939999],
            [1662299940000, "19707.35000000", "19726.01000000", "19702.83000000", "19712.64000000", "244.71185000", 1662299999999],
            [1662300000000, "19713.60000000", "19730.59000000", "19700.83000000", "19721.35000000", "256.54321000", 1662300059999],
            [1662300060000, "19721.35000000", "19721.60000000", "19702.51000000", "19705.36000000", "142.18569000", 1662300119999],
            [1662300120000, "19705.36000000", "19707.55000000", "19686.13000000", "19688.68000000", "161.24978000", 1662300179999],
            [1662300180000, "19686.82000000", "19706.52000000", "19660.00000000", "19669.23000000", "410.53543000", 1662300239999],
            [1662300240000, "19669.23000000", "19671.03000000", "19650.00000000", "19662.01000000", "304.52974000", 1662300299999],
            [1662300300000, "19662.01000000", "19675.37000000", "19654.06000000", "19660.51000000", "245.18906000", 1662300359999],
            [1662300360000, "19659.88000000", "19675.34000000", "19655.79000000", "19674.36000000", "195.35564000", 1662300419999],
            [1662300420000, "19673.58000000", "19698.26000000", "19650.00000000", "19661.60000000", "455.76053000", 1662300479999],
            [1662300480000, "19662.83000000", "19677.52000000", "19653.59000000", "19669.47000000", "173.55337000", 1662300539999],
            [1662300540000, "19669.47000000", "19690.00000000", "19665.26000000", "19687.44000000", "196.53834000", 1662300599999],
            [1662300600000, "19688.94000000", "19689.69000000", "19678.50000000", "19681.22000000", "112.44581000", 1662300659999],
            [1662300660000, "19680.26000000", "19705.61000000", "19670.31000000", "19695.48000000", "302.37180000", 1662300719999],
            [1662300720000, "19695.48000000", "19734.06000000", "19693.54000000", "19710.59000000", "376.10919000", 1662300779999],
            [1662300780000, "19709.31000000", "19735.00000000", "19702.88000000", "19732.84000000", "165.55254000", 1662300839999],
            [1662300840000, "19734.17000000", "19741.90000000", "19729.27000000", "19733.49000000", "203.68139000", 1662300899999],
            [1662300900000, "19732.08000000", "19741.99000000", "19710.47000000", "19725.50000000", "180.39768000", 1662300959999],
            [1662300960000, "19725.50000000", "19727.47000000", "19707.88000000", "19720.46000000", "132.60099000", 1662301019999],
            [1662301020000, "19721.13000000", "19723.53000000", "19708.05000000", "19721.39000000", "125.72651000", 1662301079999],
            [1662301080000, "19722.95000000", "19738.24000000", "19718.78000000", "19734.27000000", "116.24690000", 1662301139999],
            [1662301140000, "19734.27000000", "19748.61000000", "19727.64000000", "19744.32000000", "185.73012000", 1662301199999],
            [1662301200000, "19744.32000000", "19745.90000000", "19735.77000000", "19739.84000000", "117.28996000", 1662301259999],
            [1662301260000, "19739.84000000", "19741.31000000", "19722.31000000", "19727.54000000", "88.11117000", 1662301319999],
            [1662301320000, "19727.54000000", "19736.54000000", "19721.03000000", "19725.70000000", "108.95055000", 1662301379999],
            [1662301380000, "19724.73000000", "19735.00000000", "19723.06000000", "19729.40000000", "65.59090000", 1662301439999],
            [1662301440000, "19729.05000000", "19739.00000000", "19724.10000000", "19733.43000000", "70.35437000", 1662301499999],
            [1662301500000, "19733.37000000", "19737.85000000", "19725.00000000", "19728.45000000", "66.92192000", 1662301559999],
            [1662301560000, "19728.45000000", "19729.42000000", "19716.81000000", "19726.19000000", "187.42089000", 1662301619999],
            [1662301620000, "19726.19000000", "19730.32000000", "19722.69000000", "19725.10000000", "53.67309000", 1662301679999],
            [1662301680000, "19725.10000000", "19726.50000000", "19715.25000000", "19724.37000000", "85.31158000", 1662301739999],
            [1662301740000, "19725.36000000", "19729.41000000", "19722.50000000", "19726.67000000", "56.25690000", 1662301799999],
            [1662301800000, "19726.67000000", "19727.58000000", "19716.92000000", "19718.59000000", "58.31086000", 1662301859999]
        ];
    }

    public function test_trade_buy()
    {
        $trading = new Trading([
            'id' => 0,
            'name' => 'BTCUSDT',
            'settings' => ["candle"=>"1m","period"=>null,"rsi_period"=>"14","stoch_rsi_period"=>null,"rsi_min"=>"30","rsi_max"=>null,"profit_limit"=>"0.01","start_balance"=>"100"],
            'data' => $this->market_candles,
            'mark' => false,
            'status' => 'deposit',
            'is_trade' => false,
            'api' => null
        ], json_decode('{"t":1662302800000,"T":1662302859999,"s":"BTCUSDT","i":"1m","o":"19726.67000000","c":"19618.59000000","h":"19727.58000000","l":"19716.92000000","q":"58.31086000"}',true), null, true);
        $market = $trading->addNewCandle();
        $this->assertTrue($market['status'] === 'bought');
    }

    public function test_trade_sell()
    {
        $trading = new Trading([
            'id' => 0,
            'name' => 'BTCUSDT',
            'settings' => ["candle"=>"1m","period"=>null,"rsi_period"=>"14","stoch_rsi_period"=>null,"rsi_min"=>"30","rsi_max"=>null,"profit_limit"=>"0.01","start_balance"=>"100"],
            'data' => $this->market_candles,
            'mark' => false,
            'status' => 'bought',
            'is_trade' => false,
            'old_price' => 19618.59000000,
            'api' => null
        ], json_decode('{"t":1662302800000,"T":1662302859999,"s":"BTCUSDT","i":"1m","o":"19726.67000000","c":"19818.59000000","h":"19727.58000000","l":"19716.92000000","q":"58.31086000"}',true), null, true);
        $market = $trading->addNewCandle();
        $this->assertTrue($market['status'] === 'deposit');
    }
}
